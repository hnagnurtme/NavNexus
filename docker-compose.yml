version: '3.8'

services:
  # ============================
  # üóÑÔ∏è Neo4j Graph Database
  # ============================
  neo4j:
    image: neo4j:5.18-community
    container_name: navnexus-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-password}
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - navnexus-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================
  # üîç Qdrant Vector Database
  # ============================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: navnexus-qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
    networks:
      - navnexus-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============================
  # üîß Backend API (ASP.NET Core)
  # ============================
  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    container_name: navnexus-backend
    ports:
      - "8080:8080"
    environment:
      # ASP.NET Core Configuration
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:8080
      
      # Database Connections
      - NEO4J_URL=${NEO4J_URL:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      
      # Naver Cloud Platform APIs
      - NOS_KEY=${NOS_KEY}
      - NOS_SECRET=${NOS_SECRET}
      - NOS_ENDPOINT=${NOS_ENDPOINT}
      - NOS_BUCKET=${NOS_BUCKET}
      
      - PAPAGO_CLIENT_ID=${PAPAGO_CLIENT_ID}
      - PAPAGO_CLIENT_SECRET=${PAPAGO_CLIENT_SECRET}
      
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_API_URL=${LLM_API_URL:-https://clovastudio.stream.ntruss.com/testapp/v1/chat-completions/HCX-003}
      
      # Firebase Configuration
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_CREDENTIALS=${FIREBASE_CREDENTIALS}
      
      # JWT Configuration
      - JWT_KEY=${JWT_KEY}
      - JWT_ISSUER=${JWT_ISSUER:-NavNexus}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-NavNexusUsers}
      
    depends_on:
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    networks:
      - navnexus-network
    volumes:
      - backend_logs:/app/logs
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================
  # üé® Frontend (React + Vite)
  # ============================
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
    container_name: navnexus-frontend
    ports:
      - "3000:80"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:8080/api}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - navnexus-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

# ============================
# üì¶ Volumes
# ============================
volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  qdrant_storage:
    driver: local
  backend_logs:
    driver: local

# ============================
# üåê Networks
# ============================
networks:
  navnexus-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
